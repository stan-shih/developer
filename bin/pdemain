#!/bin/bash
usage="Portable Development Environment(PDE)

Usage:
  $(basename -- "$0") 
    
Command:
  setup     Setup ~/.bashrc for adding the function of starting PDE
  run       Run the project
  delete    Delete Project
  install   Install Application
  install --offline  Install Application offline

Options:
  -h, --help    Help for PDE

Example:
  $(basename -- "$0") install <application>
  $(basename -- "$0") install --offline <application> <file-or-path>
"
####
####
setup() {
    if [[ -f ~/.bashrc ]]; then
        rowNum=$(grep -n "pdemain" ~/.bashrc | cut -d ":" -f 1)
    fi
    if [[ $rowNum == '' ]]; then
        echo -e "pde() {\n    source $1/bin/pdemain \$*\n}\necho \"Can use 'pde' command to Start Portable Development Environment(PDE)\"\n" >>~/.bashrc
    else
        newPath=$1
        sed -i "${rowNum}s#\/.*\/bin\/pdemain#${newPath}\/bin\/pdemain#" ~/.bashrc
    fi
    cat ~/.bashrc
}
delete() {
    echo "Delete base directory in the home ($1)..."
    rm -rf $DEV_HOME/home/$1
    . $DEV_HOME/bin/setenv default
    cd $DEV_HOME
}
run() {
    if [[ $1 == "?" ]]; then
        ls -al $DEV_HOME/home
        return
    fi
    . $DEV_HOME/bin/setenv $*
}
install() {
    echo "Install Application..."
    while [[ $# -gt 0 ]]; do
        case "$1" in
        -f | --offline)
            if [[ "$2" == "" ]]; then
                echo "Install Application is fail!!!"
                return
            fi
            file="$2"
            otherParam="-f $file"
            shift 2
            ;;
        *)
            application=$1
            shift 1
            ;;
        esac
    done
    executeinstall $application $otherParam
}
####
getEnvOS() {
    echo $(echo $MACHTYPE | awk -F- '{print $3}')
}
osIsWindows() {
    [[ $(getEnvOS) =~ ^msys.*$ ]] && echo "Y" || echo "N"
}
osIsMac() {
    [[ $(getEnvOS) =~ ^darwin.*$ ]] && echo "Y" || echo "N"
}
osIsLinux() {
    echo "N"
}
if [[ "$1" == "getFunciton" ]]; then
    return
fi
####
#### Main Script
####
if [[ $(osIsWindows) == "Y" ]]; then
    DIR="$(cd "$(dirname $(readlink -f "${BASH_SOURCE[0]}"))/.." && pwd)"
    export OS_WINDOWS="Y"
elif [[ $(osIsMac) == "Y" ]]; then
    DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"/..; pwd)"
    export OS_MACOS="Y"
else
    echo "Sorry! PDE can't support on this system!!!"
    return
fi
if [[ ! -f $DIR/bin/setenv ]]; then
    echo "Can't found PDE HOME!!!"
    return
fi
export DEV_HOME=$DIR
echo "DEV_HOME: $DEV_HOME"
if [[ $DEV_HOME == '' ]]; then
    echo "Can't setup Portable Development Environment!!!"
    return
fi
if ! declare -F pde >/dev/null; then
    pde() {
        source $DEV_HOME/bin/pdemain $*
    }
fi
#### ==========================================================================

if [[ $1 == '' ]]; then
    run
    cd $DEV_HOME
elif [[ $1 == "run" ]]; then
    shift
    run $*
elif [[ $1 == "setup" ]]; then
    setup $DIR
elif [[ $1 == "delete" ]]; then
    shift
    delete $1
elif [[ $DEV_BASE == "" ]]; then
    echo "Please execute 'pde' first!!!"
    exit 1
elif [[ $1 == "install" ]]; then
    shift
    install $*
elif [[ $1 == "-h" ]]; then
    echo "$usage"
else
    echo "$usage"
    exit 1
fi
